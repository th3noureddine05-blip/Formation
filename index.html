<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>One Mobility - Audit Ready V17.5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --om-orange: #e67e22; --om-blue: #2c3e50; --success: #27ae60; --danger: #c0392b; --bg: #f4f7f6; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: #333; }
        .hidden { display: none !important; }
        header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--om-orange); box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .container { padding: 20px; max-width: 1000px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #home-view { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #2c3e50, #000); color: white; text-align: center; }
        .main-btn { border: 2px solid var(--om-orange); padding: 40px; border-radius: 20px; width: 280px; cursor: pointer; margin: 15px; transition: 0.3s; background: rgba(255,255,255,0.05); }
        .main-btn:hover { background: var(--om-orange); }
        #qr-container { background: white; padding: 15px; border-radius: 15px; margin: 20px 0; border: 5px solid var(--om-orange); }
        #qr-container p { color: #2c3e50; font-weight: bold; margin-top: 10px; font-size: 14px; margin-bottom: 0; }
        input, select { padding: 12px; border: 2px solid #ddd; border-radius: 10px; width: 100%; box-sizing: border-box; font-size: 16px; margin-top: 8px; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 13px; color: var(--om-blue); }
        .q-card { background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border-left: 8px solid var(--om-orange); }
        .btn-ans { padding: 15px; border: 2px solid #eee; border-radius: 10px; cursor: pointer; background: white; flex: 1; font-weight: bold; }
        .btn-ans.active { background: var(--om-orange) !important; color: white !important; }
        .btn-action { padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; }
        .badge { padding: 4px 8px; border-radius: 5px; font-weight: bold; color: white; font-size: 11px; }
        #sig-canvas { border: 2px dashed #ccc; width: 100%; height: 180px; background: #fff; touch-action: none; border-radius: 8px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .edit-row { background: #f9f9f9; padding: 10px; margin-bottom: 5px; display: flex; justify-content: space-between; border-radius: 5px; border: 1px solid #ddd; align-items: center; }
    </style>
</head>
<body>

    <div id="home-view">
        <img src="https://i.ibb.co/v4m0YmH/One-Mobility.png" height="80">
        <div id="qr-container"><div id="qrcode"></div><p>Scanner pour commencer</p></div>
        <div style="display:flex; flex-wrap:wrap; justify-content:center">
            <div class="main-btn" onclick="showSection('setup-view')"><h2>OPÉRATEUR</h2><p>Lancer un test</p></div>
            <div class="main-btn" onclick="openAdmin()"><h2>FORMATEUR</h2><p>Gestion & Stats</p></div>
        </div>
    </div>

    <div id="admin-login-modal" class="modal-overlay hidden">
        <div class="card" style="width:320px; text-align:center;">
            <h3>Accès Formateur</h3>
            <input type="password" id="admin-password-input" placeholder="••••" style="text-align:center; font-size:24px;">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-action" style="background:var(--success); flex:1" onclick="checkAdminPassword()">Entrer</button>
                <button class="btn-action" style="background:var(--danger); flex:1" onclick="closeAdminLogin()">Annuler</button>
            </div>
        </div>
    </div>

    <div id="admin-view" class="hidden">
        <header><div style="font-weight:bold">Espace Formateur</div><button onclick="location.reload()">Quitter</button></header>
        <div class="container">
            <div class="card">
                <h3 style="margin-top:0; color:var(--om-orange)">Gestion des Questions</h3>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="edit-theme-select" onchange="renderEditList()" style="flex:2"></select>
                    <button class="btn-action" style="background:var(--om-blue); flex:1" onclick="let n = prompt('Nom du module :'); if(n){DB[n]=[]; saveDB(); location.reload();}">+ Module</button>
                </div>
                <div id="edit-list" style="margin-top:15px; max-height:200px; overflow-y:auto;"></div>
            </div>

            <div class="card" style="display:flex; gap:10px;">
                <button onclick="exportToCSV()" class="btn-action" style="background:var(--success); flex:1">Export Excel (CSV)</button>
                <button onclick="clearAllLogs()" class="btn-action" style="background:var(--danger); flex:1">Reset Logs</button>
            </div>

            <div class="card">
                <h3 style="margin-top:0">Registre & Impression Groupée</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="fMat" onkeyup="updateAdminDashboard()" placeholder="Rechercher par Date, Nom ou Matricule..." style="flex:2">
                    <button id="btnGroupPdf" class="btn-action" style="background:var(--om-blue); flex:1">Imprimer Groupe PDF</button>
                </div>
                <div style="overflow-x:auto">
                    <table>
                        <thead><tr><th>Date</th><th>Matricule</th><th>Nom</th><th>Session</th><th>Score</th><th>Action</th></tr></thead>
                        <tbody id="admin-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="setup-view" class="hidden">
        <header><div>Identification</div><button onclick="location.reload()">Retour</button></header>
        <div class="container">
            <div class="card" style="max-width:450px; margin: auto;">
                <label>Matricule</label><input id="mat" type="number">
                <label>Nom & Prénom</label><input id="nom" type="text">
                <label>Date d'embauche</label><input id="date_embauche" type="date">
                <label>Module</label><select id="theme_select"></select>
                <button class="btn-action" style="background:var(--om-orange); width:100%; margin-top:25px" onclick="startQuiz()">LANCER LE TEST</button>
            </div>
        </div>
    </div>

    <div id="quiz-view" class="hidden">
        <header><div id="active-theme"></div><div id="timer">15:00</div></header>
        <div class="container">
            <div id="questions-list"></div>
            <div class="card">
                <h3>Signature Obligatoire</h3>
                <canvas id="sig-canvas"></canvas>
                <button onclick="clearSig()" style="margin-top:10px">Effacer</button>
            </div>
            <button class="btn-action" style="background:var(--success); width:100%; padding:20px;" onclick="submitTest()">VALIDER LE TEST</button>
        </div>
    </div>

    <script>
        const initialDB = {
            "Livre d’Accueil & HSE": [
                { f: "Les absences pour des raisons personnelles ne sont pas rémunérées.", a: "الغيب لأسباب شخصية غير مدفوع الأجر.", r: true },
                { f: "Le port de bijoux est interdit dans la zone de production.", a: "يمنع ارتداء المجوهرات في منطقة الإنتاج.", r: true },
                { f: "Chaque opérateur doit être à son poste au plus tard 5 minutes avant le début du shift.", a: "يجب على كل عامل أن يكون في مركز عمله 5 دقائق قبل بداية المناوبة على الأقل.", r: true },
                { f: "Le respect du règlement intérieur est une obligation pour tout employé.", a: "احترام النظام الداخلي واجب على كل موظف.", r: true },
                { f: "Le port des EPI est obligatoire dans les zones de production.", a: "ارتداء معدات الحماية الفردية إلزامي في مناطق الإنتاج.", r: true },
                { f: "L'extincteur peut être utilisé par toute personée formée.", a: "يمكن استعمال مطفأة الحريق من طرف أي شخص مدرب.", r: true },
                { f: "Même si je ne suis pas qualifié, je peux occuper un poste.", a: "يمكنني الاشتغال في محطة العمل حتى لو لم أكن مؤهلاً.", r: false },
                { f: "Un accident de travail est un événement imprévu lié au travail.", a: "حوادث الشغل هي حدث مفاجئ وغير متوقع مرتبط بالعمل.", r: true },
                { f: "Il est strictement interdit de passer sous une charge suspendue.", a: "يمنع منعاً كلياً المرور تحت حمولة معلقة.", r: true },
                { f: "Le tri des déchets contribue à la sécurité et à l'environnement.", a: "فرز النفايات يساهم في السلامة واحترام البيئة.", r: true }
            ]
        };

        let DB = JSON.parse(localStorage.getItem('OM_DB')) || initialDB;
        let userAnswers = [], sigCtx, canvas, currentModule, timerInterval;

        window.onload = () => { new QRCode(document.getElementById("qrcode"), { text: window.location.href, width: 180, height: 180 }); };

        function showSection(id) {
            document.querySelectorAll('body > div:not(header):not(.modal-overlay)').forEach(div => div.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            const opts = Object.keys(DB).map(t => `<option value="${t}">${t}</option>`).join('');
            if(id === 'setup-view') document.getElementById('theme_select').innerHTML = opts;
            if(id === 'admin-view') { document.getElementById('edit-theme-select').innerHTML = opts; renderEditList(); }
        }

        function openAdmin() { document.getElementById('admin-login-modal').classList.remove('hidden'); }
        function closeAdminLogin() { document.getElementById('admin-login-modal').classList.add('hidden'); }
        function checkAdminPassword() { if(document.getElementById('admin-password-input').value === "123") { closeAdminLogin(); showSection('admin-view'); updateAdminDashboard(); } else { alert("Code incorrect"); } }

        function renderEditList() {
            const t = document.getElementById('edit-theme-select').value;
            const container = document.getElementById('edit-list');
            if(!DB[t]) return;
            container.innerHTML = DB[t].map((q, i) => `<div class="edit-row"><span>Q${i+1}: ${q.f.substring(0,30)}...</span><button onclick="DB['${t}'].splice(${i},1); saveDB(); renderEditList();" style="color:red; border:none; background:none; cursor:pointer">X</button></div>`).join('');
        }

        function startQuiz() {
            const m = document.getElementById('mat').value; const n = document.getElementById('nom').value;
            if(!m || !n) return alert("Remplir tout");
            currentModule = document.getElementById('theme_select').value;
            showSection('quiz-view');
            document.getElementById('active-theme').innerText = currentModule;
            userAnswers = new Array(DB[currentModule].length).fill(null);
            document.getElementById('questions-list').innerHTML = DB[currentModule].map((q, i) => `
                <div class="q-card">
                    <b>${i+1}. ${q.f}</b><br><small dir="rtl">${q.a}</small>
                    <div style="display:flex; gap:10px; margin-top:15px">
                        <button class="btn-ans" id="v-${i}" onclick="setAns(${i}, true)">VRAI</button>
                        <button class="btn-ans" id="f-${i}" onclick="setAns(${i}, false)">FAUX</button>
                    </div>
                </div>`).join('');
            initSignature(); startTimer(900);
        }

        function setAns(i, v) { userAnswers[i] = v; document.getElementById(`v-${i}`).className = v ? 'btn-ans active' : 'btn-ans'; document.getElementById(`f-${i}`).className = !v ? 'btn-ans active' : 'btn-ans'; }
        function startTimer(d) { let t = d; clearInterval(timerInterval); timerInterval = setInterval(() => { let m = parseInt(t/60), s = parseInt(t%60); document.getElementById('timer').innerText = `${m}:${s<10?'0':''}${s}`; if(--t < 0) { clearInterval(timerInterval); submitTest(); } }, 1000); }

        function submitTest() {
            if(userAnswers.includes(null)) return alert("Répondez à tout");
            const score = Math.round((userAnswers.filter((a,i) => a === DB[currentModule][i].r).length / DB[currentModule].length) * 100);
            let logs = JSON.parse(localStorage.getItem('OM_LOGS')) || [];
            const attempt = logs.filter(l => l.mat === document.getElementById('mat').value && l.theme === currentModule).length + 1;
            logs.push({ date: new Date().toLocaleDateString('fr-FR'), mat: document.getElementById('mat').value, nom: document.getElementById('nom').value, theme: currentModule, score: score, attempt: attempt, ans: [...userAnswers], questions: JSON.parse(JSON.stringify(DB[currentModule])), sig: canvas.toDataURL('image/png', 0.5) });
            localStorage.setItem('OM_LOGS', JSON.stringify(logs));
            alert("Score: " + score + "%"); location.reload();
        }

        function updateAdminDashboard() {
            const logs = JSON.parse(localStorage.getItem('OM_LOGS')) || [];
            const f = document.getElementById('fMat').value.toLowerCase();
            const filtered = logs.filter(l => l.mat.includes(f) || l.nom.toLowerCase().includes(f) || l.date.includes(f));
            document.getElementById('admin-body').innerHTML = filtered.reverse().map((l) => `
                <tr><td>${l.date}</td><td>${l.mat}</td><td>${l.nom}</td><td>Test n°${l.attempt}</td>
                <td><span class="badge" style="background:${l.score>=75?'var(--success)':'var(--danger)'}">${l.score}%</span></td>
                <td><button onclick="downloadPDF_Single(${logs.indexOf(l)})">PDF</button></td></tr>`).join('');
            
            // الربط الصحيح لزر الطباعة الجماعية مع النتائج المفلترة
            document.getElementById('btnGroupPdf').onclick = () => printGroupPDF(filtered);
        }

        function downloadPDF_Single(idx) {
            const logs = JSON.parse(localStorage.getItem('OM_LOGS')) || [];
            const l = logs[idx];
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            renderFiche(doc, l);
            doc.save(`Audit_${l.mat}.pdf`);
        }

        function printGroupPDF(filteredLogs) {
            if(!filteredLogs || filteredLogs.length === 0) return alert("Aucun résultat");
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            filteredLogs.forEach((l, i) => { 
                if(i > 0) doc.addPage(); 
                renderFiche(doc, l); 
            });
            doc.save(`Groupe_Audits.pdf`);
        }

        function renderFiche(doc, l) {
            doc.setFont("helvetica", "bold"); doc.setFontSize(22); doc.setTextColor(230, 126, 34); doc.text("ONE MOBILITY", 105, 20, { align: "center" });
            doc.setFontSize(14); doc.setTextColor(44, 62, 80); doc.text("FICHE D'ÉVALUATION DES COMPÉTENCES", 105, 30, { align: "center" });
            doc.line(20, 35, 190, 35); doc.setFontSize(11); doc.setTextColor(0);
            doc.text(`Candidat : ${l.nom}`, 20, 45); doc.text(`Matricule : ${l.mat}`, 20, 52); doc.text(`Module : ${l.theme}`, 20, 59);
            doc.text(`Date : ${l.date}`, 130, 45); doc.setTextColor(230, 126, 34); doc.text(`Test : n°${l.attempt}`, 130, 52);
            const isOk = l.score >= 75; doc.setTextColor(isOk ? 39 : 192, isOk ? 174 : 57, isOk ? 96 : 43); doc.text(`Score : ${l.score}%`, 130, 59);
            doc.autoTable({ startY: 68, head: [['#', 'Critères', 'Réponse', 'Résultat']], body: l.questions.map((q, i) => [i + 1, q.f, l.ans[i] ? "VRAI" : "FAUX", (l.ans[i] === q.r) ? "CONFORME" : "NON CONFORME"]), theme: 'grid', headStyles: { fillColor: [44, 62, 80] }, didParseCell: (d) => { if(d.column.index === 3 && d.cell.section === 'body') d.cell.styles.textColor = d.cell.raw === 'CONFORME' ? [39, 174, 96] : [192, 57, 43]; } });
            const fy = doc.lastAutoTable.finalY + 15; doc.setTextColor(0); doc.text("Signature du Collaborateur", 30, fy); 
            if(l.sig) try { doc.addImage(l.sig, 'PNG', 30, fy + 5, 45, 20); } catch(e){}
        }

        function initSignature() {
            canvas = document.getElementById('sig-canvas'); sigCtx = canvas.getContext('2d'); canvas.width = canvas.offsetWidth;
            let d = false;
            const s = (e) => { d = true; sigCtx.beginPath(); const r = canvas.getBoundingClientRect(); sigCtx.moveTo((e.clientX || e.touches[0].clientX)-r.left, (e.clientY || e.touches[0].clientY)-r.top); if(e.touches) e.preventDefault(); };
            const m = (e) => { if(!d) return; const r = canvas.getBoundingClientRect(); sigCtx.lineTo((e.clientX || e.touches[0].clientX)-r.left, (e.clientY || e.touches[0].clientY)-r.top); sigCtx.stroke(); if(e.touches) e.preventDefault(); };
            canvas.onmousedown = canvas.ontouchstart = s; canvas.onmousemove = canvas.ontouchmove = m; window.onmouseup = window.ontouchend = () => d = false;
        }
        function clearSig() { sigCtx.clearRect(0,0,canvas.width,canvas.height); }
        function saveDB() { localStorage.setItem('OM_DB', JSON.stringify(DB)); }
        function clearAllLogs() { if(confirm("Supprimer l'historique?")) { localStorage.removeItem('OM_LOGS'); updateAdminDashboard(); } }
        function exportToCSV() { const logs = JSON.parse(localStorage.getItem('OM_LOGS')) || []; let csv = "\uFEFFDate;Mat;Nom;Score;Session\n" + logs.map(l => `${l.date};${l.mat};${l.nom};${l.score}%;Test n°${l.attempt}`).join("\n"); const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = "Registre.csv"; a.click(); }
    </script>
</body>
</html>
