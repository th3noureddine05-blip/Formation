<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>One Mobility - Quiz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --om-orange: #e67e22; --om-blue: #2c3e50; --bg: #f4f7f6; --success: #27ae60; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); }
        .hidden { display: none !important; }
        header { background: white; padding: 15px; display: flex; justify-content: center; border-bottom: 4px solid var(--om-orange); position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; max-width: 800px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #home-view { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; color: white; text-align: center; }
        .main-btn { border: 2px solid var(--om-orange); padding: 30px; border-radius: 15px; width: 260px; cursor: pointer; font-weight: bold; }
        input, select { padding: 12px; border: 2px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 16px; margin-top: 8px; }
        .q-card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 6px solid var(--om-orange); }
        .btn-ans { padding: 15px; border: 2px solid #eee; border-radius: 8px; cursor: pointer; background: white; flex: 1; font-weight: bold; }
        .btn-ans.active { background: var(--om-orange); color: white; border-color: var(--om-orange); }
        #sig-canvas { border: 2px dashed #ccc; width: 100%; height: 160px; background: #fff; touch-action: none; border-radius: 8px; margin-top: 10px; }
        .btn-action { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; width: 100%; background: var(--success); font-size: 16px; }
    </style>
</head>
<body>

    <div id="home-view">
        <img src="https://i.ibb.co/v4m0YmH/One-Mobility.png" height="80">
        <div id="qrcode" style="background:white; padding:10px; margin:20px; border-radius:10px;"></div>
        <div class="main-btn" onclick="showSection('setup-view')">COMMENCER LE TEST</div>
    </div>

    <div id="setup-view" class="hidden">
        <header><img src="https://i.ibb.co/v4m0YmH/One-Mobility.png" height="40"></header>
        <div class="container">
            <div class="card">
                <label>Matricule</label><input id="mat" type="number">
                <label>Nom & Prénom</label><input id="nom" type="text">
                <label>Date d'embauche</label><input id="date_embauche" type="date">
                <label>Module</label><select id="theme_select"></select>
                <button class="btn-action" style="background:var(--om-orange); margin-top:20px" onclick="startQuiz()">LANCER</button>
            </div>
        </div>
    </div>

    <div id="quiz-view" class="hidden">
        <header><div id="active-theme" style="font-weight: bold;"></div></header>
        <div class="container">
            <div id="questions-list"></div>
            <div class="card">
                <h3>Signature obligatoire</h3>
                <canvas id="sig-canvas"></canvas>
                <button onclick="sigCtx.clearRect(0,0,canvas.width,canvas.height)" style="margin-top:5px; border:none; background:none; color:grey; text-decoration:underline;">Effacer</button>
            </div>
            <button class="btn-action" onclick="submitTest()">VALIDER LE TEST</button>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxFp7SuiXeyJvhksWJUQyDdUq2OVF8Z7YAf6UYcEwkjN_QK7GgFFpuoIdPQ1CF3rOrTmg/exec';

        const DB = { 
            "Qualité & 14 Principes": [
                { f: "La qualité est la responsabilité de tous les employés.", r: true },
                { f: "Le respect des procédures est obligatoire.", r: true },
                { f: "La non-conformité doit être signalée immédiatement.", r: true },
                { f: "La prévention est plus importante que la correction.", r: true },
                { f: "Le contrôle des outils de mesure est facultatif.", r: false },
                { f: "La maintenance autonome est réservée aux techniciens.", r: false },
                { f: "Je dois vérifier la calibration de mon instrument.", r: true },
                { f: "Le principe 'Stop Sign' signifie qu'on ne s'arrête jamais.", r: false },
                { f: "Une validation qualité est requise après chaque maintenance.", r: true },
                { f: "On peut envoyer un produit douteux au client.", r: false }
            ]
        };

        let userAnswers = [], sigCtx, canvas, currentModule;

        window.onload = () => { new QRCode(document.getElementById("qrcode"), { text: window.location.href, width: 120, height: 120 }); };

        function showSection(id) {
            document.querySelectorAll('body > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'setup-view') {
                document.getElementById('theme_select').innerHTML = Object.keys(DB).map(t => `<option value="${t}">${t}</option>`).join('');
            }
        }

        function startQuiz() {
            if(!document.getElementById('mat').value || !document.getElementById('nom').value) return alert("Champs obligatoires !");
            currentModule = document.getElementById('theme_select').value;
            showSection('quiz-view');
            document.getElementById('active-theme').innerText = currentModule;
            userAnswers = new Array(DB[currentModule].length).fill(null);
            document.getElementById('questions-list').innerHTML = DB[currentModule].map((q, i) => `
                <div class="q-card">
                    <b>${i+1}. ${q.f}</b>
                    <div style="display:flex; gap:10px; margin-top:15px">
                        <button class="btn-ans" id="v-${i}" onclick="setAns(${i},true)">VRAI</button>
                        <button class="btn-ans" id="f-${i}" onclick="setAns(${i},false)">FAUX</button>
                    </div>
                </div>`).join('');
            initSig();
        }

        function setAns(i, v) { 
            userAnswers[i] = v; 
            document.getElementById(`v-${i}`).className = v ? 'btn-ans active' : 'btn-ans'; 
            document.getElementById(`f-${i}`).className = !v ? 'btn-ans active' : 'btn-ans'; 
        }

        function initSig() {
            canvas = document.getElementById('sig-canvas'); sigCtx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            const draw = (e) => {
                if(e.buttons !== 1 && !e.touches) return;
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                sigCtx.lineWidth = 2; sigCtx.lineTo(x, y); sigCtx.stroke();
            };
            canvas.onmousedown = (e) => { sigCtx.beginPath(); draw(e); };
            canvas.onmousemove = draw;
            canvas.ontouchstart = (e) => { e.preventDefault(); sigCtx.beginPath(); draw(e); };
            canvas.ontouchmove = (e) => { e.preventDefault(); draw(e); };
        }

        function submitTest() {
            if(userAnswers.includes(null)) return alert("Répondez à tout.");
            const score = Math.round((userAnswers.filter((a,i) => a === DB[currentModule][i].r).length / DB[currentModule].length) * 100);
            
            const data = {
                date: new Date().toLocaleDateString('fr-FR'),
                mat: document.getElementById('mat').value,
                nom: document.getElementById('nom').value,
                embauche: document.getElementById('date_embauche').value,
                theme: currentModule,
                score: score,
                attempt: 1 // محاولة بسيطة
            };

            fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
            .then(() => {
                alert("Merci ! Votre résultat a été envoyé au formateur.");
                location.reload();
            })
            .catch(() => {
                alert("Erreur d'envoi. Vérifiez votre connexion.");
            });
        }
    </script>
</body>
</html>
