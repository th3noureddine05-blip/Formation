<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>One Mobility - Audit V18.5 PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --om-orange: #e67e22; --om-blue: #2c3e50; --success: #27ae60; --danger: #c0392b; --bg: #f4f7f6; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; }
        .hidden { display: none !important; }
        header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--om-orange); box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .container { padding: 20px; max-width: 1000px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #home-view { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #2c3e50, #000); color: white; text-align: center; }
        .main-btn { border: 2px solid var(--om-orange); padding: 40px; border-radius: 20px; width: 280px; cursor: pointer; margin: 15px; transition: 0.3s; background: rgba(255,255,255,0.05); }
        .main-btn:hover { background: var(--om-orange); }
        #qr-container { background: white; padding: 15px; border-radius: 15px; margin: 20px 0; border: 5px solid var(--om-orange); }
        input, select, textarea { padding: 12px; border: 2px solid #ddd; border-radius: 10px; width: 100%; box-sizing: border-box; font-size: 16px; margin-top: 8px; font-family: inherit; }
        .q-card { background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; border-left: 8px solid var(--om-orange); }
        .btn-ans { padding: 15px; border: 2px solid #eee; border-radius: 10px; cursor: pointer; background: white; flex: 1; font-weight: bold; }
        .btn-ans.active { background: var(--om-orange) !important; color: white !important; }
        .btn-action { padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; }
        #sig-canvas { border: 2px dashed #ccc; width: 100%; height: 180px; background: #fff; touch-action: none; border-radius: 8px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; }
    </style>
</head>
<body>

    <div id="home-view">
        <img src="https://i.ibb.co/v4m0YmH/One-Mobility.png" height="80">
        <div id="qr-container"><div id="qrcode"></div><p style="color:black">Scanner pour commencer</p></div>
        <div style="display:flex; flex-wrap:wrap; justify-content:center">
            <div class="main-btn" onclick="showSection('setup-view')"><h2>OPÃ‰RATEUR</h2><p>Lancer un test</p></div>
            <div class="main-btn" onclick="openAdmin()"><h2>FORMATEUR</h2><p>Gestion & Archives</p></div>
        </div>
    </div>

    <div id="admin-login-modal" class="modal-overlay hidden">
        <div class="card" style="width:320px; text-align:center;">
            <h3>AccÃ¨s Formateur</h3>
            <input type="password" id="admin-password-input" placeholder="â€¢â€¢â€¢â€¢" style="text-align:center; font-size:24px;">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-action" style="background:var(--success); flex:1" onclick="checkAdminPassword()">Entrer</button>
                <button class="btn-action" style="background:var(--danger); flex:1" onclick="closeAdminLogin()">Annuler</button>
            </div>
        </div>
    </div>

    <div id="admin-view" class="hidden">
        <header><div style="font-weight:bold">Espace Administration</div><button onclick="location.reload()">Quitter</button></header>
        <div class="container">
            
            <div class="card">
                <h3>ðŸ›  Ajouter une Question</h3>
                <select id="target-theme-select"></select>
                <textarea id="new-q-fr" placeholder="Question en FranÃ§ais"></textarea>
                <textarea id="new-q-ar" placeholder="Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" dir="rtl"></textarea>
                <div style="margin-top:10px">
                    <label>RÃ©ponse Correcte:</label>
                    <select id="new-q-res" style="width:auto; margin-left:10px">
                        <option value="true">VRAI</option>
                        <option value="false">FAUX</option>
                    </select>
                </div>
                <button class="btn-action" style="background:var(--om-blue); width:100%; margin-top:15px" onclick="saveNewQuestion()">AJOUTER LA QUESTION</button>
            </div>

            <div class="card">
                <h3>ðŸ“‹ Gestion des Modules</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <select id="edit-theme-select" onchange="renderEditList()" style="flex:2"></select>
                    <button class="btn-action" style="background:var(--om-orange); flex:1" onclick="addNewModule()">+ Module</button>
                </div>
                <div id="edit-list" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:8px"></div>
            </div>

            <div class="card">
                <h3>Archives des Tests</h3>
                <div style="overflow-x:auto">
                    <table>
                        <thead><tr><th>Date</th><th>Nom</th><th>Score</th><th>Action</th></tr></thead>
                        <tbody id="admin-body"></tbody>
                    </table>
                </div>
                <button onclick="clearLogs()" class="btn-action" style="background:var(--danger); width:100%; margin-top:15px">Vider l'historique local</button>
            </div>
        </div>
    </div>

    <div id="setup-view" class="hidden">
        <header><div>Identification</div><button onclick="location.reload()">Retour</button></header>
        <div class="container">
            <div class="card" style="max-width:450px; margin: auto;">
                <label>Matricule</label><input id="mat" type="number">
                <label>Nom & PrÃ©nom</label><input id="nom" type="text">
                <label>Date d'embauche</label><input id="date_embauche" type="date">
                <label>Module</label><select id="theme_select"></select>
                <button class="btn-action" style="background:var(--om-orange); width:100%; margin-top:25px" onclick="startQuiz()">LANCER LE TEST</button>
            </div>
        </div>
    </div>

    <div id="quiz-view" class="hidden">
        <header><div id="active-theme"></div><div id="timer">15:00</div></header>
        <div class="container">
            <div id="questions-list"></div>
            <div class="card">
                <h3>Signature Obligatoire</h3>
                <canvas id="sig-canvas"></canvas>
            </div>
            <button class="btn-action" style="background:var(--success); width:100%; padding:20px;" onclick="submitTest()">VALIDER LE TEST</button>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxFp7SuiXeyJvhksWJUQyDdUq2OVF8Z7YAf6UYcEwkjN_QK7GgFFpuoIdPQ1CF3rOrTmg/exec';
        
        let DB = JSON.parse(localStorage.getItem('OM_DB')) || {
            "Flux, Composants & Lean": [
                { f: "Un cÃ¢ble est un ensemble de fils et connecteurs.", a: "Ø§Ù„ÙƒØ§Ø¨Ù„ Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø£Ø³Ù„Ø§Ùƒ ÙˆØ§Ù„Ù…ÙˆØµÙ„Ø§Øª.", r: true },
                { f: "Le Lean sert uniquement Ã  rÃ©duire les coÃ»ts.", a: "ÙŠØ®Ø¯Ù… Ø§Ù„Ù€ Lean ÙÙ‚Ø· Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ.", r: false }
            ]
        };

        let userAnswers = [], sigCtx, canvas, currentModule, timerInterval;

        window.onload = () => { new QRCode(document.getElementById("qrcode"), { text: window.location.href, width: 150, height: 150 }); };

        function showSection(id) {
            document.querySelectorAll('body > div:not(header):not(.modal-overlay)').forEach(div => div.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            const themes = Object.keys(DB).map(t => `<option value="${t}">${t}</option>`).join('');
            if(id === 'setup-view' || id === 'admin-view') {
                document.getElementById('theme_select').innerHTML = themes;
                if(id === 'admin-view') {
                    document.getElementById('edit-theme-select').innerHTML = themes;
                    document.getElementById('target-theme-select').innerHTML = themes;
                    renderEditList();
                    renderAdminLogs();
                }
            }
        }

        function openAdmin() { document.getElementById('admin-login-modal').classList.remove('hidden'); }
        function closeAdminLogin() { document.getElementById('admin-login-modal').classList.add('hidden'); }
        function checkAdminPassword() { if(document.getElementById('admin-password-input').value === "123") { closeAdminLogin(); showSection('admin-view'); } else alert("AccÃ¨s RefusÃ©"); }

        function saveNewQuestion() {
            const theme = document.getElementById('target-theme-select').value;
            const fr = document.getElementById('new-q-fr').value;
            const ar = document.getElementById('new-q-ar').value;
            const res = document.getElementById('new-q-res').value === "true";
            if(!fr) return alert("Texte FR obligatoire");
            DB[theme].push({ f: fr, a: ar, r: res });
            localStorage.setItem('OM_DB', JSON.stringify(DB));
            document.getElementById('new-q-fr').value = '';
            document.getElementById('new-q-ar').value = '';
            renderEditList();
        }

        function renderEditList() {
            const t = document.getElementById('edit-theme-select').value;
            document.getElementById('edit-list').innerHTML = DB[t].map((q, i) => `
                <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:white">
                    <div style="font-size:12px"><b>Q${i+1}:</b> ${q.f}</div>
                    <button onclick="deleteQ('${t}',${i})" style="color:red; border:none; background:none; font-size:18px; cursor:pointer">ðŸ—‘</button>
                </div>`).join('');
        }

        function deleteQ(t, i) { if(confirm("Supprimer?")) { DB[t].splice(i,1); localStorage.setItem('OM_DB', JSON.stringify(DB)); renderEditList(); } }

        function addNewModule() {
            const name = prompt("Nom du nouveau module:");
            if(name) { DB[name] = []; localStorage.setItem('OM_DB', JSON.stringify(DB)); showSection('admin-view'); }
        }

        function startQuiz() {
            if(!document.getElementById('mat').value || !document.getElementById('nom').value) return alert("Infos manquantes");
            currentModule = document.getElementById('theme_select').value;
            showSection('quiz-view');
            document.getElementById('active-theme').innerText = currentModule;
            userAnswers = new Array(DB[currentModule].length).fill(null);
            document.getElementById('questions-list').innerHTML = DB[currentModule].map((q, i) => `
                <div class="q-card">
                    <b>${i+1}. ${q.f}</b><br><small dir="rtl">${q.a || ''}</small>
                    <div style="display:flex; gap:10px; margin-top:15px">
                        <button class="btn-ans" id="v-${i}" onclick="setAns(${i}, true)">VRAI</button>
                        <button class="btn-ans" id="f-${i}" onclick="setAns(${i}, false)">FAUX</button>
                    </div>
                </div>`).join('');
            setTimeout(initSignature, 500);
            startTimer(900);
        }

        function setAns(i, v) { userAnswers[i] = v; document.getElementById(`v-${i}`).className = v ? 'btn-ans active' : 'btn-ans'; document.getElementById(`f-${i}`).className = !v ? 'btn-ans active' : 'btn-ans'; }

        function initSignature() {
            canvas = document.getElementById('sig-canvas'); sigCtx = canvas.getContext('2d'); canvas.width = canvas.offsetWidth;
            let drawing = false;
            const start = (e) => { drawing = true; sigCtx.beginPath(); e.preventDefault(); };
            const move = (e) => {
                if(!drawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                sigCtx.lineTo(x, y); sigCtx.stroke();
                e.preventDefault();
            };
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move);
            canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', move);
            window.addEventListener('mouseup', () => drawing = false);
        }

        function submitTest() {
            if(userAnswers.includes(null)) return alert("RÃ©pondez Ã  tout");
            const score = Math.round((userAnswers.filter((a,i) => a === DB[currentModule][i].r).length / DB[currentModule].length) * 100);
            const data = {
                date: new Date().toLocaleDateString('fr-FR'),
                mat: document.getElementById('mat').value,
                nom: document.getElementById('nom').value,
                embauche: document.getElementById('date_embauche').value,
                theme: currentModule,
                score: score,
                sig: canvas.toDataURL(),
                ans: userAnswers,
                questions: DB[currentModule]
            };
            let logs = JSON.parse(localStorage.getItem('OM_LOGS')) || [];
            logs.push(data);
            localStorage.setItem('OM_LOGS', JSON.stringify(logs));
            fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) }).then(() => { alert("EnvoyÃ©! Score: " + score + "%"); location.reload(); });
        }

        function renderAdminLogs() {
            const logs = JSON.parse(localStorage.getItem('OM_LOGS')) || [];
            document.getElementById('admin-body').innerHTML = logs.reverse().map((l, i) => `
                <tr><td>${l.date}</td><td>${l.nom}</td><td>${l.score}%</td>
                <td><button onclick="downloadPDF(${logs.length-1-i})">PDF</button></td></tr>`).join('');
        }

        function downloadPDF(idx) {
            const l = (JSON.parse(localStorage.getItem('OM_LOGS')) || [])[idx];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Header Original
            doc.setFontSize(22); doc.setTextColor(230, 126, 34); doc.text("ONE MOBILITY", 105, 20, {align:'center'});
            doc.setFontSize(16); doc.setTextColor(44, 62, 80); doc.text("FICHE D'Ã‰VALUATION DES COMPÃ‰TENCES", 105, 30, {align:'center'});
            doc.setLineWidth(0.5); doc.line(20, 35, 190, 35);

            // Infos
            doc.setFontSize(11); doc.setTextColor(0); doc.setFont("helvetica", "bold");
            doc.text(`Candidat :  ${l.nom}`, 20, 50);
            doc.text(`Matricule :  ${l.mat}`, 20, 58);
            doc.text(`Date d'embauche :  ${l.embauche}`, 20, 66);
            doc.text(`Date Test :  ${l.date}`, 130, 50);
            doc.text(`Module :  ${l.theme}`, 130, 58);
            doc.text(`Test :  Test 1`, 130, 66);
            doc.setTextColor(200, 0, 0); doc.text(`Score : ${l.score}%`, 130, 74);

            // Table
            doc.autoTable({
                startY: 85,
                head: [['#', 'CritÃ¨res', 'RÃ©ponse', 'RÃ©sultat']],
                body: l.questions.map((q, i) => [i + 1, q.f, l.ans[i] ? 'VRAI' : 'FAUX', (l.ans[i] === q.r) ? 'CONFORME' : 'NON CONFORME']),
                theme: 'grid',
                headStyles: { fillColor: [44, 62, 80] },
                columnStyles: { 1: {cellWidth: 110} }
            });

            doc.setTextColor(0); doc.text("Signature du Collaborateur", 30, doc.lastAutoTable.finalY + 15);
            doc.addImage(l.sig, 'PNG', 35, doc.lastAutoTable.finalY + 18, 40, 15);
            doc.save(`Audit_${l.mat}.pdf`);
        }

        function startTimer(d) { let t = d; clearInterval(timerInterval); timerInterval = setInterval(() => { let m = parseInt(t/60), s = parseInt(t%60); document.getElementById('timer').innerText = `${m}:${s<10?'0':''}${s}`; if(--t < 0) { clearInterval(timerInterval); submitTest(); } }, 1000); }
        function clearLogs() { if(confirm("Effacer l'historique?")) { localStorage.removeItem('OM_LOGS'); renderAdminLogs(); } }
    </script>
</body>
</html>
